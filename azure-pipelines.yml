trigger:
- main

pool:
  name: Default

variables:
  stagePath: '/home/azureuser/deploy-temp'
  updateScript: '/opt/odoo17/update_code.sh'
  repoUrl: 'git@github.com:souravb-smu/odoo17.git'
  branchName: 'main'

steps:
- checkout: self
  clean: true

- task: SSH@0
  displayName: "Pull only changed files into stagePath"
  inputs:
    sshEndpoint: ssh-odoo17
    runOptions: commands
    commands: |
      #!/bin/bash
      set -e

      echo ">>> Using stagePath: $(stagePath)"
      echo ">>> Repo: $(repoUrl)"
      echo ">>> Branch: $(branchName)"

      # Ensure stagePath exists
      mkdir -p "$(stagePath)"
      cd "$(stagePath)"

      # Fetch only changed files
      if [ ! -d ".git" ]; then
        echo ">>> First time clone"
        git init
        git remote add origin "$(repoUrl)"
        git fetch --depth 1 origin "$(branchName)"
        git checkout -f FETCH_HEAD
      else
        echo ">>> Pulling latest changes"
        git fetch origin "$(branchName)"
        git reset --hard origin/"$(branchName)"
      fi

      # Remove unwanted files (if any)
      rm -f .DS_Store || true

      echo ">>> Stage folder ready:"
      ls -la