trigger:
- main

pool:
  name: Default

variables:
  stagePath: '/home/azureuser/deploy-temp'
  updateScript: '/opt/odoo17/update_code.sh'
  repoUrl: 'git@github.com:souravb-smu/odoo17.git'
  branchName: 'main'

steps:
- checkout: self
  clean: true

- task: SSH@0
  displayName: "Fresh clone into stagePath with exclusions (simple)"
  inputs:
    sshEndpoint: ssh-odoo17
    runOptions: commands
    commands: |
      set -e

      # Use Azure variables directly so they are expanded before SSH
      echo ">>> Using stagePath: $(stagePath)"
      echo ">>> Repo: $(repoUrl)"
      echo ">>> Branch: $(branchName)"

      # Ensure stage path exists
      mkdir -p "$(stagePath)"
      cd "$(stagePath)"

      # Make the directory empty so we can clone into '.'
      # Keep the directory itself, remove only contents (including hidden files)
      rm -rf ./* ./.??* || true

      echo ">>> Cloning repo (shallow) into $(stagePath)"
      git clone --depth 1 --branch "$(branchName)" "$(repoUrl)" .

      echo ">>> Removing unwanted folders/files"
      rm -rf .git
      rm -rf .github
      rm -rf **/filestore 2>/dev/null || true
      rm -rf **/.local/share/Odoo 2>/dev/null || true
      rm -rf custom-addons/helpdesk 2>/dev/null || true
      rm -f .DS_Store

      echo ">>> Staging folder ready:"
      ls -la