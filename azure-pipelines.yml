trigger:
- main

pool:
  name: Default

variables:
  stagePath: '/home/azureuser/deploy-temp'
  updateScript: '/opt/odoo17/update_code.sh'
  repoUrl: 'git@github.com:souravb-smu/odoo17.git'
  branchName: 'main'

steps:
- checkout: self
  clean: true

- task: SSH@0
  displayName: Update stagePath only if git has changes (exclude unwanted paths)
  inputs:
    sshEndpoint: ssh-odoo17
    runOptions: commands
    commands: |
      set -e

      mkdir -p "$(stagePath)"
      cd "$(stagePath)"

      # First-time setup: shallow clone
      if [ ! -d ".git" ]; then
        echo ">>> First-time clone"
        git clone --depth 1 --branch "$(branchName)" "$(repoUrl)" .
        echo ">>> Enable sparse-checkout and exclude unwanted paths"
        git sparse-checkout init --no-cone
        # Include everything, then exclude specific paths (arguments avoid heredoc)
        git sparse-checkout set \
          '/*' \
          '!/.github/**' \
          '!/**/filestore/**' \
          '!/**/.local/share/Odoo/**' \
          '!/custom-addons/helpdesk/**' \
          '!/.DS_Store'
        exit 0
      fi

      # Existing repo: ensure remote/branch and sparse rules are set (idempotent)
      git remote set-url origin "$(repoUrl)" || true

      # Make sure target branch exists locally
      if ! git rev-parse --verify "$(branchName)" >/dev/null 2>&1; then
        git fetch --prune origin
        git checkout -b "$(branchName)" "origin/$(branchName)"
      else
        git checkout "$(branchName)"
      fi

      # (Re)apply sparse-checkout exclusions safely
      git sparse-checkout init --no-cone || true
      git sparse-checkout set \
        '/*' \
        '!/.github/**' \
        '!/**/filestore/**' \
        '!/**/.local/share/Odoo/**' \
        '!/custom-addons/helpdesk/**' \
        '!/.DS_Store'

      # Fetch and only update if there are changes
      git fetch origin "$(branchName)" --depth=1

      LOCAL="$(git rev-parse HEAD)"
      REMOTE="$(git rev-parse origin/$(branchName))"

      if [ "$LOCAL" = "$REMOTE" ]; then
        echo ">>> No changes in git. Skipping update."
        exit 0
      fi

      echo ">>> Changes detected, updating working tree to origin/$(branchName)"
      git reset --hard "origin/$(branchName)"
      git clean -fdx

      echo ">>> Updated to latest commit:"
      git --no-pager log -1 --oneline

- task: SSH@0
  displayName: Run update script on VM
  inputs:
    sshEndpoint: ssh-odoo17
    runOptions: commands
    commands: |
      sudo -n true || (echo "ERROR: azureuser NOPASSWD not effective" && exit 1)
      #sudo "$(updateScript)"
    readyTimeout: 20000